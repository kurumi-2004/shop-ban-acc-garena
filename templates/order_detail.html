{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-md-8">
        <div class="card" data-aos="fade-right">
            <div class="card-body">
                <h3>Chi tiết đơn hàng #{{ order.id }}</h3>
                <hr>
                <div class="row mb-3">
                    <div class="col-md-6">
                        <p><strong>Ngày đặt:</strong> {{ order.created_at.strftime('%d/%m/%Y %H:%M') }}</p>
                        <p><strong>Trạng thái:</strong> 
                            <span class="order-status {{ order.status }}">
                                {% if order.status == 'pending' %}Chờ thanh toán
                                {% elif order.status == 'processing' %}Đang xử lý
                                {% elif order.status == 'completed' %}Hoàn thành
                                {% else %}Đã hủy{% endif %}
                            </span>
                        </p>
                        <p><strong>Phương thức:</strong> 
                            {% if order.payment_method == 'vietqr' %}
                            <span class="badge bg-success"><i class="fas fa-qrcode"></i> VietQR</span>
                            {% else %}
                            {{ order.payment_method }}
                            {% endif %}
                        </p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>Khách hàng:</strong> {{ order.customer_name }}</p>
                        <p><strong>Email:</strong> {{ order.customer_email }}</p>
                        {% if order.customer_phone %}
                        <p><strong>Điện thoại:</strong> {{ order.customer_phone }}</p>
                        {% endif %}
                        {% if order.payment_reference %}
                        <p><strong>Mã thanh toán:</strong> <code>{{ order.payment_reference }}</code></p>
                        {% endif %}
                    </div>
                </div>
                
                <h5>Danh sách tài khoản:</h5>
                {% for account in order.accounts %}
                <div class="card mb-3">
                    <div class="card-body">
                        <h6>{{ account.title }}</h6>
                        <div class="account-tags mb-2">
                            <span class="tag">{{ account.category }}</span>
                            {% if account.rank %}
                            <span class="tag rank">{{ account.rank }}</span>
                            {% endif %}
                        </div>
                        <p><strong>Giá:</strong> {{ "{:,.0f}".format(account.price) }} ₫</p>
                        
                        {% if order.status == 'completed' %}
                        <div class="credentials-box">
                            <p><strong>Thông tin đăng nhập:</strong></p>
                            <p>{{ account.get_decrypted_username() }}|{{ account.get_decrypted_password() }}</p>
                        </div>
                        <div class="alert alert-warning mt-2">
                            <small><i class="fas fa-exclamation-triangle"></i> Vui lòng đổi mật khẩu sau khi nhận tài khoản</small>
                        </div>
                        {% else %}
                        <div class="credentials-hidden">
                            <i class="fas fa-lock fa-2x mb-2"></i>
                            <p>Đang chờ thanh toán hoàn tất</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card" data-aos="fade-left">
            <div class="card-body">
                <h5>Tổng đơn hàng</h5>
                <hr>
                <div class="d-flex justify-content-between mb-2">
                    <span>Số tài khoản:</span>
                    <strong>{{ order.accounts.count() }}</strong>
                </div>
                <div class="d-flex justify-content-between mb-3">
                    <h5>Tổng tiền:</h5>
                    <h5 class="text-primary">{{ "{:,.0f}".format(order.total_amount) }} ₫</h5>
                </div>
                
                {% if order.status == 'completed' %}
                <div class="alert alert-success">
                    <i class="fas fa-check-circle"></i> Đơn hàng đã hoàn thành!
                </div>
                {% elif order.status == 'pending' %}
                <div class="alert alert-warning">
                    <i class="fas fa-clock"></i> Đang chờ thanh toán
                </div>
                <a href="{{ url_for('payment', order_id=order.id) }}" class="btn btn-primary w-100 mb-2">
                    <i class="fas fa-qrcode"></i> Thanh toán VietQR
                </a>
                {% elif order.status == 'processing' %}
                <div class="alert alert-info">
                    <i class="fas fa-spinner"></i> Đang xử lý thanh toán
                </div>
                {% if current_user.has_permission('support') %}
                <button onclick="completePayment({{ order.id }})" class="btn btn-success w-100 mb-2">
                    <i class="fas fa-check"></i> Xác nhận thanh toán
                </button>
                {% endif %}
                {% endif %}
                
                <a href="{{ url_for('orders') }}" class="btn btn-outline-secondary w-100">
                    <i class="fas fa-arrow-left"></i> Quay lại
                </a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function completePayment(orderId) {
    if (!confirm('Xác nhận đã nhận thanh toán cho đơn hàng này?')) {
        return;
    }
    
    const csrfToken = '{{ csrf_token() }}';
    
    fetch(`/admin/order/${orderId}/complete-payment`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast(data.message, 'success');
            setTimeout(() => {
                location.reload();
            }, 1000);
        } else {
            showToast(data.message, 'error');
        }
    })
    .catch(error => {
        showToast('Có lỗi xảy ra', 'error');
    });
}
</script>
{% endblock %}
